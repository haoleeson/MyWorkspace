layout: post
title: 交换机基础简介
date: 2021/8/9 22:30:45
updated: 2021/8/9 22:10:45
comments: true
tags: 
- Network
categories:
- 技术

---

# 1. 交换机概述
- **基本概念**：英文名为 switch，也称为交换式集线器，是一种基于**MAC地址识别**，能完成**封装转发数据包**功能的网络设备。
- **功能**：可以学习**MAC地址**，并把其存放在内部**MAC地址对照表**中，通过在数据帧的始发者和目标接受者之间建立临时的交换路径，是数据帧直接由源地址到达目的地址。

<!-- more -->

# 2. switch 简介

## 2.1. 工作特点
- 拥有一条很高带宽的**背板总线**和**内部交换矩阵**
- 所有端口都挂接在这条背板总线上
- 控制电路收到数据包后，处理端口会查找内存中的**MAC地址对照表**。若能够查询到**目的MAC地址**，则查询该**目的MAC地址**的网卡挂接在哪个**端口**上，然后通过内部交换矩阵迅速将数据包传送到**目的端口**；若表中不存在**目的MAC地址**，则广播到所有端口，接收端口回应后交换机会"学习"新地址，并把它添加到内部**MAC地址对照表**中。

## 2.2. 特性
- 支持并行通信，提升了信息吞吐量
- （大局域网）用户分组，每个端口连接一台设备或一个工作组，有效解决拥挤
- 虚拟局域网 VLAN，给交换机使用和管理提供更大灵活性
- 端口密度可以与集线器相媲美

## 2.3. 三个主要功能
1. **学习**
以太网交换机了解每一端口相连设备的**MAC地址**，并将地址相应的端口映射信息缓存到**MAC地址对照表**中
2. **转发/过滤**
当一个数据帧的目的地址在**MAC地址**表中时，将它转发到连接目的地址端口。若**MAC地址**表中不存在时，广播**MAC地址**到所有端口，并在接收端口回应后"学习"新地址与端口的映射，并缓存到**MAC地址对照表**中
3. **消除回路**
当交换机包括一个冗余回路时，以太网交换机通过生成树协议避免回路的产生，同时允许存在后备路径。

# 3. switch 交换模式

## 3.1. 存储转发（Store and Forward）
- 流程：交换机接收到数据包后，首先将数据包**存储到缓冲器**中，进行** CRC 循环冗余校验**。若存在 CRC 错误，则将该包丢弃；若无 CRC 错误，且数据包完整，则将其转发到**目的MAC地址**对应端口。
- 优点：不会转发残缺数据包（可减少不必要的数据转发）
- 缺点：转发速率比直接转发方式慢
- 适用场景：普通链路质量或质量较为恶劣的网络环境
- 特点：延迟与帧大小有关

## 3.2. 直通交换（Cut-Through）
- 流程：交换机只读出数据帧的前 6 个字节（目的**MAC地址**），将其转发到对应端口
- 优点：转发速率快、减少延时、提升整体吞吐率
- 缺点：无法消除流经整个交换机网络的垃圾通信包
- 适用场景：网络链路质量好、错误数据包较少的网络环境
- 特点：延迟与帧大小无关

## 3.3. 碎片丢弃（Fragment free）
- 流程：检查数据包长度，若小于 64 个字节（假包），丢弃该包；若大于等于 64 个字节，则读出数据帧的前 6 个字节（目的**MAC地址**），将其转发到对应端口
- 优点：兼具了数据包校验和传输速率
- 适用场景：一般通讯链路

# 4. switch 与网桥/集线器对比
|       设备        | ISO 网络模型层 |   传输信息   |
| :---------------: | :-----------: | :----------: |
| 路由器/三层交换机 |    网络层     | 包（Packet） |
|    交换机/网桥    |  数据链路层   | 帧（Frame）  |
|   集线器/中继器   |    物理层     | 比特（bit）  |

## 4.1. vs 网桥
|              |              网桥              |                         交换机                          |
| :----------: | :----------------------------: | :-----------------------------------------------------: |
| 交换实现方式 | 计算机运行桥接协议（软件）实现 |                专用集成电路（硬件）实现                 |
|   转发速度   |               慢               |                           快                            |
|     延迟     |               高               |                           低                            |
|    端口数    |               少               |                           多                            |
|   支持功能   |           转发/过滤            | 转发/过滤、网络管理协议、虚拟局域网的划分等诸多管理功能 |

## 4.2. vs 集线器
|              | 集线器                             | 交换机                                                                 |
| :----------: | :--------------------------------- | :--------------------------------------------------------------------- |
|   工作层级   | 物理层                             | 数据链路层，或网络层、传输层、甚至更高层                               |
| 数据传输方式 | 广播方式（所有端口处在一个冲突域） | 数据传输只发生在源端口与目的端口之间，交换机的每个端口处在不同的冲突域 |
| 带宽占用方式 | 所有端口共享集线器的总带宽         | 每个端口具有独立带宽                                                   |
|   传输模式   | 半双工                             | 全双工                                                                 |

# 5. switch 的分类

## 5.1. 按应用区域划分
- 广域网交换机：主要应用与电信领域，提供通信基础平台
- 局域网交换机：应用于局域网络，用于连接终端设备，如 PC 机及网络打印机等

## 5.2. 按网络拓扑结构划分

### 5.2.1. 核心层交换机
**简介：**
- 是整个网络的中心交换机，具有最高的交换性能，用于连接和汇聚各汇聚层交换机的流量
- 一般采用 3 层交换机 (eg. Cisco4000, 4500, 6500...)，具有很高的交换背板带宽和较多的高速以太网端口或光纤端口
- 一般采用机箱式模块化涉及，机箱中可承载管理模块、光端口模块、高速电口模块、电源等

### 5.2.2. 汇聚层交换机
**简介：**
- 用于汇聚接入层交换机的流量，并上联至核心层交换机
- 一般采用 3 层交换机 (eg.Cisco3550, 华为 Quidway S3526E)，这类交换机一般具有一定数量的高速端口，以提供具有较高的接入能力和带宽
- 可以是机箱式模块化交换机，也可以是固定配置的交换机，一般会包含光端口、高速电口等端口

### 5.2.3. 接入层交换机
**简介：**
- 通常将网络中直接面向用户连接或访问网络的部分称为接入层，一般是固定配置的交换机
- 端口密度较大，具有较高的接入能力。以 10/100M 端口为主，以固定端口或扩展槽方式提供 100Mbps 的上联端口

## 5.3. 按架构特点划分
- 机架式
- 带扩展槽固定配置式
- 不带扩展槽固定配置式

## 5.4. 按位于 OSI 七层网络模型的层级划分
- 数据链路层（第二层）：基于**MAC地址**的工作的第二层交换机最为普遍，用于网络接入层与汇聚层
- 网络层（第三层）：基于 IP 地址和协议进行交换的第三层交换机应用与网络的核心层，也少量应用于汇聚层。（部分第三层交换机也同时具有第四层交换功能）
- 传输层（第四层）：可以根据数据帧的协议端口信息进行目标端口判断。
- 应用层（第七层）：应用型交换机，主要用于互联网数据中心。

## 5.5. 按交换机的可管理性划分
- 可管理型交换机：可管理型交换机便于网络监控、流量分析，但成本也相对较高；大中型网络在汇聚层应该选择可管理型交换机；核心层交换机则全部是可管理型交换机。
- 不可管理型交换机：在接入层视应用需要而定

## 5.6. 按可否堆叠划分
- 可堆叠交换机
- 不可堆叠交换机

## 5.7. 按应用角度划分
- 电话交换机（PBX）：主要应用于电信领域，提供语音通讯
- 数据交换机（Switch）：应用于计算机网络

# 6. switch 主要性能指标

## 6.1. 背板带宽与端口速率
背板带宽和端口速率是衡量交换机的交换能力的主要参数。

### 6.1.1. 背板带宽
通过交换机所有通信的最大值

### 6.1.2. 交换机的端口速率
每秒通过的比特数

eg. 10Mbps, 100Mbps, 1000Mbps, 10000Mbps

## 6.2. 模块化与固定配置

### 6.2.1. 模块化交换机
具有很强的可扩展性，可在机箱内提供一系列扩展模块，以将具有不同协议、不同拓扑结构的网络连接起来。

eg. 千兆位以太网模块、FDDI 模块、ATM 模块、快速以太网模块、令牌环模块等

但它的价格一般很昂贵，一般用作为骨干交换机

### 6.2.2. 固定配置交换机
一般具有固定端口配置的交换机。

eg.Cisco 公司的 Catalyst I900/2900 交换机，Bay 公司的 BayStack350/450 交换机等。

价格较低，但可扩充性不如模块化交换机。

## 6.3. 专用芯片与通用芯片
- x86：通用计算机芯片
- ASIC：专用集成电路（Application-Specific-Integrated Circuit）
- NP：专用网络处理器

## 6.4. 单/多MAC地址类型
- 单MAC交换机：每个端口只有一个MAC地址；单MAC交换机主要用于连接最终用户、网络共享资源或非桥接路由器，它们不能用于连接集线器或含有多个网络设备的网段；
- 多MAC交换机：每个端口捆绑有多个MAC硬件地址；多MAC交换机的每个端口可以看作是一个集线器，而多MAC交换机可以看作是集线器的集线器。

# 7. 交换机的接口与连接方式

## 7.1. 交换机的接口类型
交换机的接口是随着网络类型的变化和传输介质的发展而产生的不同的接口规格，主要有：

### 7.1.1. 双绞线 RJ-45 接口
数量最多、应用最广的一种接口类型，它属于以太接口类型。它不仅在最基本的 10Base-T 以太网网络中使用，还在目前主流的 100Base-TX 快速以太网和 1000Base-TX 千兆以太网中使用。

### 7.1.2. 光纤接口
目前光纤传输介质发展相当迅速，各种光纤接口也层出不穷，分别应用于 100Base-FX、1000Base-FX 等网络中。

### 7.1.3. AUI 接口与 BNC
- AUI 接口：这是专门用于连接粗同轴电缆的，目前这种网络在局域网中已不多见。
- BNC 接口：这是专门用于连接细同轴电缆的接口，目前提供这种接口的交换机比较少见。

### 7.1.4. Console 接口
用于配置交换机而是用的接口。

不同交换机的 Console 接口有所不同，有些与 Cisco 路由器一样采用 RJ-45 类型 Console 接口，而有的则采用串口作为 Console 接口

### 7.1.5. FDDI 接口
光纤分布式数据接口，在早期的 100Mbps 时代的一种 FDDI 网络类型接口。其传输介质为光纤，目前已较少见。

## 7.2. 交换机的连接方式

### 7.2.1. 级联
最常见的连接方式，即使用网线将两个交换机连接起来。有使用光纤介质连接和双绞线介质连接两种情况：
- 光纤介质连接：直接连接的两个交换机端口要保证一致的光纤规格、端口速率，发送信号光纤端口与接收信号光纤端口相连。
- 双绞线介质连接：普通端口之间相连——使用交叉双绞线；一台交换机使用 Uplink 端口相连——使用直通双绞线

### 7.2.2. 冗余
两种工作方式连接：
- Spanning Tree 冗余连接：工作方式是 StandBy，一条链路在工作，其余链路处于待机（StandBy）状态，效率没有提高，可靠性提高。
- PortTrunking 连接：多条冗余连接链路实现负载分担；交换机之间联结带宽成倍提高，可靠性已得到增强

### 7.2.3. 堆叠
多台交换机的堆叠是靠一个提供背板总线带宽的多口堆叠**母模块**与单口的堆叠**子模块**相连实现的，并插入不同的交换机实现交换机的堆叠。

备注：只有支持堆叠的交换机之间才可以进行堆叠。

**交换机堆叠连接方法** ：

堆叠中所有的交换机在拓扑结构上可视为一个整体的交换机来管理。

堆叠优势：增加用户端口、更高的用户带宽、便于统一管理整个堆叠交换机拓扑网络。

常用堆叠方式：
- 菊花型：堆叠口首尾相连，是一种类似于普通的交换机之间级联连接，通过相对高速的端口串接和软件支持，最终实现构建一个多交换机的层叠结构。
- 星型：星型堆叠即一个主交换机以及多个与该主交换机相连的多台交换机构成的星型网络拓扑的堆叠方式。

### 7.2.4. 级联和堆叠的对比
|                |                           级联                           |                  堆叠                  |
| :------------: | :------------------------------------------------------: | :------------------------------------: |
|    连接方式    |                两台交换机通过两个 Port 互联                |    交换机通过专门的背板堆叠模块相连    |
|     通用行     | 可通过光纤或双绞线在任何网络设备厂家的交换机之间进行连接 | 只能在支持堆叠的交换机设备之间堆叠连接 |
|    连接距离    |                   较远（一百~几百米）                    |                几米以内                |
| 能否增加总带宽 |                            否                            |                   能                   |

# 8. 多层交换

## 8.1. 三层交换
- 概念：是相对于传统交换概念而提出的（传统交换技术是在 OSI 网络标准模型中的**第二层**数据链路层进行操作的），而三层交换技术是在网络模型中的**第三层**网络层实现了数据包的**高速转发**。简单来说，三层交换技术就是：二层交换技术 + 三层转发技术。

- 原理：三层交换机的路由记忆功能是由**路由缓存**来实现的，其实质上是将二层交换机与路由器结合起来的网络设备，它既可以完成数据交换功能，又可以完成数据路由功能。

- 优点：解决了局域网中网段划分后，网段间子网必须依赖路由器进行管理的局面，解决了传统路由器低速、复杂所造成的网络瓶颈问题。

## 8.2. 多层交换
- 概念：凡事超越传统工作的第二层数据链路层的交换统称为——多层交换
- 第四层交换：在第四层传输层的交换。其作用为在端到端性能和服务质量要求方面，实现对所有联网设备的负载进行细致的均衡，以保证客户机与服务器之间数据平滑地流动。
- 第七层交换：在第七层应用层的交换。其作用为在高可用和负载均衡方面，可利用由应用返回给最终用户的第七层信息，为用户提供便捷的确认站点内容的响应性和正确性。 

# 9. 交换机端口分类
交换机上的端口分为三种一种是接入层端口**直连**设备的，叫做 Access；一种是交换机和交换机之间的端口负责**汇聚**的叫做 Trunk，还有一种是 Access 与 Trunk 混合的模式，叫做 Hybrid。

## 9.1. 不同接口类型下的 VLAN 间通信流程

| 接口类型   | 不带 Tag 报文处理                                                                                     | 带 Tag 报文处理                                                                      | 发送帧处理流程                                                                                                                          |
| :--------- | :-------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------- |
| Access 接口 | 接收该报文，并打上缺省的 VLAN ID                                                                     | 当 VLAN ID 与缺省 VLAN ID 相同（合法）时，接收该报文；不合法时丢弃该报文               | 先剥离帧的 PVID Tag，然后再发送                                                                                                          |
| Trunk 接口  | 打上缺省的 VLAN ID，当缺省 VLAN ID 在允许通过的 VLAN ID 列表里（合法）时，接收该报文；不合法时丢弃该报文 | 当 VLAN ID 在接口允许通过的 VLAN ID 列表里（合法）时，接收该报文；不合法时丢弃该报文   | 若不是接口允许通过的 VLAN ID 时，则丢弃该报文。当 VLAN ID 与缺省 VLAN ID 相同（合法）时，去掉 Tag，发送该报文。不合法时保持原有 Tag，发送该报文 |
| Hybrid 接口 | 打上缺省的 VLAN ID，当缺省 VLAN ID 在允许通过的 VLAN ID 列表里（合法）时，接收该报文。不合法时丢弃该报文 | 当 VLAN ID 在接口允许通过的 VLAN ID 列表里（合法）时，接收该报文；不合法时丢弃该报文 | 当 VLAN ID 是该接口允许通过的 VLAN ID 时，发送该报文。可以通过命令设置发送时是否携带 Tag                                                     |

# 10. 参考资料
- [详解交换机基础知识](https://mp.weixin.qq.com/s?search_click_id=10063577871016826066-1626490825247-452760&sub=&__biz=MzAxNzU3NjcxOA==&mid=2650725002&idx=2&sn=d61b005f733aa534fa792a08e3ea2a8e&chksm=83e91cebb49e95fda30e9a74010c844442f79ec14a691ab9afcad55505febf5e47fa4ac51a87&scene=3&subscene=10000&clicktime=1626490825&enterid=1626490825&ascene=0&devicetype=android-29&version=28000737&nettype=WIFI&abtest_cookie=AAACAA%3D%3D&lang=zh_CN&exportkey=ASpa0Hemse%2BiZ8QTZ0NEw7M%3D&pass_ticket=W5SLqGGBIm6sTtDFh9%2FFpeQO0DfiWKzR42%2BbP%2FKFJwyuesaB3YXa6pM7zC40EJ79&wx_header=1)

- [交换机中常见的相关术语](https://mp.weixin.qq.com/s?__biz=MzAxMzgxMjIxNg==&mid=2651358625&idx=1&sn=12226bab937470888bfe27e486328f4e&chksm=8060cd36b717442070afd915aa475a1a89075845908e0c742f0c1cd0713e0f9206c05ffafaf0&mpshare=1&scene=24&srcid=0716mJAaYWtKhmTkI61NyNLv&sharer_sharetime=1626369740847&sharer_shareid=ae3ffc0e2d3538e9d0d75e04ccae9d3a&ascene=14&devicetype=android-29&version=28000737&nettype=WIFI&abtest_cookie=AAACAA%3D%3D&lang=zh_CN&exportkey=AZ5D1ZkwVmG4oEzUQS6UnKo%3D&pass_ticket=W5SLqGGBIm6sTtDFh9%2FFpeQO0DfiWKzR42%2BbP%2FKFJwyuesaB3YXa6pM7zC40EJ79&wx_header=1)
